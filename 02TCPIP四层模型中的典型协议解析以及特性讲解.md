# 02TCP/IP四层模型中的典型协议解析以及特性讲解

## 1.应用层

负责应用程序之间的数据传输

知名协议：

### HTTP协议

（**超文本传输协议**）

#### 网址-URL

（统一资源定位符）

http://user:password@www.example.jp:80/dir/index.htm?uid=1#ch1

协议方案名称：//用户名：密码@服务器地址：端口号/请求资源路径？查询字符串(key=val&key=val形式)#片段标识符

#### URL编码/解码：

查询字符串是用户提交给服务器的数据信息；

这些提交的数据中若是出现特殊字符，则有可能与URL中间隔符产生歧义导致URL解析失败，因此查询字符串中不能出现特殊字符。

若是提交的数据中真的有特殊字符需要对查询字符串中的数据进行URL编码操作；编码之后的数据在对端需要进行URL解码操作

**URL编码**：url中特殊字符都有特殊含义，因此用户提交数据中若存在特殊字符则需要转码。

​                    将特殊字符每一个字节转换为16进制数字字符串，并且为了表明这两个字符是经过了URL编码后的数据，需要在转换后                               					的数据前加上%。'+'----->'%2B'

**URL解码**：在用户提交的数据中遇到'%'时，则认为紧跟其后的两个字符需要转码，将第一个字符转换为数字左移4位与第2个字符					转换后的数据进行相加。'%2B'->('2' - '0') << 4 + ('b' - 'a' + 10) -> 43 -> '+'

一个中文：%2e%3e%4d

#### HTTP协议格式

##### 首行

​	（1）**请求首行：	请求方法+URL+协议版本**

- 请求方法：GET/POST（还有其他的方法）	get没有正文，提交的数据在URL的查询字符串中；post有正文，提交的数据在正文中
- 协议版本：HTTP  0.9/1.0/1.1/2 
- 各个版本新的特性：HTTP 2开始，服务器端可以主动向客户端发送信息

​	（2）**响应首行：	协议版本	响应状态码	状态码描述信息**

​		响应状态码：1** / 2 ** /3** /4** /5**

 		教程：https://www.runoob.com/http/http-status-codes.html

- 1**：信息性状态码，描述信息，接收的请求正在处理；
- 2**：成功状态码，客户端请求已经正确处理并响应；典型：200（请求成功。一般用于GET与POST请求）
- 3**：重定向状态码，需要进行附加操作以完成请求；典型：302（临时移动。与301类似。但资源只是临时被移动。客户端应继续使用原有URI）
- 4**：客户端错误状态码，服务器无法处理请求；典型：404（服务器无法根据客户端的请求找到资源（网页））
- 5**：服务器端错误状态码，服务器处理请求出错；典型：502（作为网关或者代理工作的服务器尝试执行请求时，从远程服务器接收到了一个无效的响应）、500（服务器内部错误）

##### 头部

头部信息格式：以一个个key: val组成的键值对，并且各个键值对之间以\r\n作为间隔

例如：key: val\r\nkey: val\r\n

HTTP常见Header

- Content-Type:描述的是正文是什么类型的数据（text/html等）

- Content-Length(正文的总长度)/Transfer-Encoding（每次发送到长度）:正文的长度chuncked

- Host:客户端告知服务器，所请求的资源是在那个主机的哪个端口上

- location:搭配3**重定向状态码使用，告诉客户端接下来去哪里访问

- User-Agent:声明用户的操作系统和浏览器版本信息

- referer:当前的页面是从哪个页面跳转过来的 

- Cookie:用于在客户端存储少量信息，通常用于实现会话(session)的功能

  expires:Cookie 的时间信息，显示什么时候过期

- Set-Cookie:设置和页面关联的Cookie，服务器返回的信息

  

空行\r\n	用于间隔头部与正文

通过\r\n\r\n识别头部结尾，通过头部中Content-Length获取正文数据

##### 正文



#### HTTP的方法

- GET	获取资源
- POST    传输实体主题
- PUT    传输文件
- HEAD    获得报文首部
- DELETE    删除文件
- OPTIONS    询问支持方法
- TRACE    追踪路径

### 2.4TCP协议

（传输控制协议）：要对数据的传输进行一个详细的控制；

#### 三个特性

面向连接、可靠传输、面向字节流

#### 2.4.1连接管理

- [ ] tcp三次握手四次挥手

##### 问题1.为什么握手是三次而挥手是四次？

握手三次原因：两次不安全，四次没必要

两次不安全，有可能SYN会延迟，缺乏状态保护的情况下，收到一个SYN会建立一个新的socket；完整的状态保护避免对一个客户端创建多个socket

两次不安全，服务端无法通过客户端的SYN确定客户端具有收发数据的能力，需要服务端再次进行确认

挥手四次原因：

被动关闭方，收到FIN后对其进行ACK回复，但是不能直接关闭socket，因为这时候用户有可能正在处理数据（socket接收缓冲区中有可能还有堆积的数据），需要用户来确认什么时候关闭socket发送FIN；因此ACK和FIN不能放在一起



##### 问题2.若是三次握手失败，服务端如何处理？

服务端超时等待ACK（等待客户端发ACK报文等不到）之后，向客户端发送rst报文，然后释放新建的socket资源



##### 问题3：主动关闭方TIME_WAIT状态的作用？

1.主动关闭方假设没有time_wait而是直接进入closed状态，释放socket资源会造成的危害

在主动关闭方发送的最后一次ACK丢失的情况下：

如果主动关闭方使用相同的地址信息立即重启，

​	1.收到被动关闭方超时等待后重发的FIN包，对新连接造成影响

​	2.重启后的新的主动关闭方发送SYN请求，但是此时被动关闭方等待的是ACK，因为状态不对导致对新连接造成影响

因此主动关闭方需要等待一段时间：等待2个MSL时间

​	若是对方重发FIN请求，可以对其再次进行确认回复

##### MSL:报文最大生命周期 	30秒

​	等待两个MSL时间是为了让网络中延迟的报文（后续重传的FIN和ACK）都消失网络中不会对后续连接造成影响

问题4：服务端出现

大量time_wait解决方案：调正MSL时间，设置套接字选项（地址复用）



- [ ] 调研：syn泛洪攻击

  

#### 2.4.2可靠传输

##### 面向连接

##### 确认应答(ACK)机制

对每一条数据，向发送方进行确认回复

TCP将每个字节的数据进行了编号，即为序列号。目的是：为了按顺序读取

每一个ACK都带有对应的确认序列号，意思是告诉发送者，我已经收到了哪些数据，下一次你从哪里开始发

##### 超时重传机制

发送数据后等待一段时间（200ms），若是没有收到确认回复，则认为数据丢失，进行重传

确认应答机制+超时重传机制->保证数据到达

协议字段中的：序号+确认序号->保证数据有序的向应用层交付

##### 协议字段中的校验和

校验接收的数据与发送的数据是否一致，不一致则发送重传请求，否则确认回复

##### TCP为了保证可靠传输，牺牲了部分性能

有些性能的损失是没必要的，比如ACK丢失导致的重传

TCP又采用了几种机制来避免无谓的性能损失以及提高性能的方法

###### 1.滑动窗口机制

一发一收的方式性能太低，一次发送多条数据就可以大大提高性能。

**1.1流量控制**

**解决问题**：接收端处理数据的速度是有限的。如果发送端发的太快，导致接收端的缓冲区被打满，这个时候如果发送端继续发送，就会造成丢包，继而引起丢包重传等等一系列连锁反应。

**解决方法**：通过协议字段中的窗口大小（不会大于接收方的接收缓冲区中剩余空间大小）字段控制发送方发送的数据大小；

窗口大小在每次对数据进行确认回复的时候都会进行重新协商



每一条确认回复中的确认序号，都要保证之前的数据已经完全收到

没有收到第一条回复，但是收到了第二条回复，认为第一条和第二条都已经正确传输，避免因为ACK丢失而导致的数据重传



1.2快速重传机制

接收方收到第二条数据，但是没有收到第一条，则初步认为第一条数据丢失，则立即发送第一条数据的重传请求，并且连续发送三次

当发送方连续收到三次重传请求的时候，就不需要等待超时，直接对这条数据进行重传

连续三次，是因为要避免因为网络阻塞，数据延迟到达而导致的重传



1.3拥塞控制

在网络通信开始时，并不会直接发送窗口大小的数据，而是以一种慢启动、快增长的形式进行数据传输，起到一个网络探测的作用，避免开始通信时因为网络状况不好导致的发送数据越多，丢失数据越多的重传性能损失，在快增长的过程中，若出现丢包则初始化拥塞窗口大小，重新开始探测网络状况；



###### 2.延迟应答机制

接收方接收数据若是立即回复，则窗口大小会降低，会导致传输速度降低，因此接收方接收到数据后，并不立即回复，而延迟一会（不超过500ms），在者期间，用户可能将数据从接收缓冲区中取出，可以尽最大的能力保证窗口大小，保证传输速度不会降低；

###### 3.捎带应答机制

每次接收方对发送到数据进行确认回复，若是单独发送一个数据报（仅仅包含以下tcp报头）是不划算的，解决方案是将要进行的确认回复和即将要发送的数据合到一起进行发送，就可省略一个tcp报头的发送，减少网络中不必要的流量信息；



**tcp的可靠传输：**

​	**连接管理，确认应答，超时重传，序号/确认序号，校验和**

​	**滑动窗口机制（流类控制，拥塞控制，快速重传），延迟应答，捎带应答**



#### 2.4.3面向字节流

数据不会直接发送，而是放到缓冲区中，操作系统选择一个合适的时机将合适大小的数据以字节流的形式发送出去，对方接收数据时可以一次性接收所有数据，也可以一次接收一点，分多次接收



**tcp面向字节流特性：传输灵活，但会造成粘包问题**

##### **1.粘包问题**

tcp传输的数据在发送缓冲区或者接收缓冲区中堆积，因为tcp数据收发的灵活性，导致有可能多条数据当作一条接收；（两条数据的粘连）

tcp粘包的本质原因：tcp在传输层，对数据的格式并不关心，对数据之间没有边界区分，因此造成数据的粘包

粘包时tcp在传输层对数据边界不敏感，因此**需要用户在应用层进行数据边界管理**

**边界管理的三种方法**

（1）特殊字符间隔；局限性：数据中含有特殊字符

（2）定长数据；局限性：定长的选择决定，过大、过小

（3）不定长数据在应用协议头中声明数据长度（最佳方案）；在应用层声明数据报长度



#### 2.4.4tcp连接管理中的保活机制

​	若是通信双方，长时间（7200s）没有数据往来，则会向对方发送保活探测数据包（要求对方对这个保活探测数据包进行回复），若是收到回复，则认为连接正常，若是间隔（75s）连续多次（9次）没有收到回复，则认为连接断开

​	**tcp异常连接断开的情况**：断电

#### 2.4.5tcp协议字段格式

16位源/目的端口：负责端与端之间的数据传输

32位序号/确认序号：保证数据有序交付

4位首部长度：解析时获取tcp头部，以4字节为单位（tcp头部最小20字节，最大60字节）

6位标志位：

- URG：紧急指针是否有效
- ACK：确认号是否有效
- PSH：提示接收端把接收缓冲区中的数据尽快拿走
- RST：对方要求重新建立连接，把携带RST标识的称为复位报文段
- SYN：请求建立连接，携带SYN标识的称为同步报文段
- FIN:通知对方，本端要关闭了，携带FIN标识的称为结束报文段

16位窗口大小：实现滑动窗口，以及进行流量控制

16位校验和：保证数据一致性

16位紧急指针：带外数据

40字节的选项数据：可有可无

## 3.网络层

负责地址管理和路由选择；ip;路由器

### **路由选择**

在复杂的网络环境中为每一条数据都选择一条合适的路径

路由表：每个路由器上都有一个路由表，记录的连接在路由器上的网络

Destination		Gateway		Genmark		   Iface

192.168.122.0							255.255.255.0    eth1

192.168.10.0							  255.255.255.0    eth0

default

​							192.168.10.1								   eth0



192.168.122.2（C类地址）

192.168.122--网络号

2--主机号



在网络中的ip地址，不能随意分配，因为随意分配很容易造成ip地址冲突；因此ip地址需要得到合理的管理才可以

一个路由器可以组建一个局域网，这时候路由器向局域网中的主机分配ip地址的时候，就必须带有自己网络的标识----网路号；这时候只需要将每个网络的网络号规范起来就可以避免ip地址冲突；

在一个局域网中，路由器向主机分配ip地址，还要能够在局域网中标识这个主机，这个标识叫主机号

**IP的组成：网络号+主机号**

网络号：保证相互连接的两个网段具有不同的标识；
主机号：同一网段内，主机之间具有相同的网络号，但是必须有不同的主机号；

保证相邻的网络不能具有相同的网络号就可以尽可能的避免IP地址冲突



### IP协议字段

格式：

4位版本号：标明协议版本IPV4/IPV6

4位头部长度：IP报文头最大长度60个字节（以4个字节为单位）

8为服务类型：4位TOS字段（最小延时/最大吞吐量/最高可靠性/最小成本），1位保留位

16位报文长度：限制一个IP报文最大长度64K       UDP数据最大长度：64K-20-8

MTU:最大传输单元

当mtu<UDP数据长度<64K-20-8时，链路层则不支持大于mtu大小的数据传输，这时，网络层先获取下层mtu大小，在网络层对数据进行分片

16位标识：UDP数据有可能在网络层进行数据分片，这个标识则可以指定当前分片属于哪个UDP数据包

3位标志：1位已经弃用，1位表示是否禁止分片，1位用于标识分片末尾

13位片偏移：用于指定UDP数据分片相对于UDP数据包起始位置的偏移量（分片在数据包中的位置）

​	偏移量是以8字节为单位，每个分片都是8的整数倍长度（最后一个不一定）

8位生存时间（ttl）：报文生命周期，最大经过的路由器跳数

8位上层协议：用于数据分用时，决定由上层哪个协议进行解析

16位校验和：校验数据一致性

32位源/目的IP地址：标识数据从哪来到哪去

40字节选项数据：可有可无

**IP头部最小20字节，最大60字节**



### **网段的划分**

早期划分方式：A/B/C/D/E

![img](D:/MYLEARN/MyYNOTE/qq1B8E9C7D54A2F5A15187982E0B488A2F/aad9c6cdabe24e0fb9a46b0bd9593eac/clipboard.png)

A类地址:低24位是主机号，A类网络地址主机号有2^24个	地址范围：0.0.0.0~127.255.255.255

B类地址：低16位是主机号，B类网络地址主机号有65536个	地址范围：128.0.0.0~191.255.255.255

C类地址：低8位是主机号，C类网络地址主机号有256个	地址范围：192.0.0.0~223.255.255.255

D类地址：224.0.0.0~239.255.255.255

E类地址：240.0.0.0~247.255.255.255



### 子网掩码

引入：解决传统划分方案的局限性，避免大量IP地址的浪费

解决方案-CIDR方案：加入了一个字段叫子网掩码，通过子网掩码来对网络进行划分

​	子网掩码：有一串连续的二进制1组成的一个无符号4个字节的整数

192.168.122.132	255.255.255.0

作用：

（1）IP地址与子网掩码相与能够得到网络号192.168.122.132&255.255.255.0=192.168.122.0

（2）子网掩码取反，可以得到网络中主机号的个数~255.255.255.0 = 255+1=256

#### 问题1

现在有一个C类网络地址，将这个C类网络划分出20个子网，请问每个子网的子网掩码是多少，IP地址范围是多少，以及各自网络的网络号是多少？

C类网络地址有256个主机号，平均划分20个子网，每个子网中主机号个数256/20

因为子网掩码取反可得网络中主机号的个数；

所以每个子网中主机号个数是12；子网掩码是连续的1，因此12取反无法得到连续1，在每个子网主机号能少不能多的情况下，为了保证子网掩码是连续的1，因此主机号个数最好是8，得到最大主机号7（8-1）

~0.0.0.7 = 255.255.255.248

#### 问题2

现在有一个C类网络地址，将这个C类网络划分出4个子网，请问每个子网的子网掩码是多少，IP地址范围是多少，以及各自网络的网络号是多少？C类地址：192.168.122.132/24

每个子网中主机号个数256/4 = 64

~63就能得到每个网络的子网掩码

~0.0.0.63 = 255.255.255.192

​                   IP地址范围										网络号																

192.168.122.0~192.168.122.63           	192.168.122.0

192.168.122.64~192.168.122.127	  	192.168.122.64

192.168.122.128~192.168.122.191 	  192.168.122.128

192.168.122.192~192.168.122.255	   192.168.122.192



在一个网络中，并不是所有的主机号都能分配给主机

主机号全为0的IP地址---网络号，用于标识一个网络

主机号全为1的IP地址---UDP广播地址，用于给同一个链路中相互连接的所有主机发送数据包；

127.0.0.1--本机虚拟回环网卡地址--用于本机的网络测试

**相邻的网络不能使用相同的网络号**



### IP地址的数量限制

IPV4地址有32位，那么一共就有2的32次方个IP地址，大概是43亿左右，但是TCP/IP协议规定，每个主机都需要一个IP地址；然而，实际上，由于一些特殊IP地址的存在，数量远不足43亿；另外IP地址并非是按照主机台数来配置的，而是每一个网卡都需要配置一个或多个IP地址。

CIDR在一定程度上缓解了Ip地址不够用的问题（提高了利用率，减少了浪费，但是IP地址的绝对上限并没有增加），仍然不是很够用，以下提出了三种解决方式：

1）**动态分配IP地址**：只给接入网络的设备分配IP地址，因此同一个MAC地址的设备，每次接入互联网中，得到的IP地址不一定是相同的；

2）**NAT技术**；子网内的主机需要和外网进行通信时，路由器将IP首部中的IP地址进行替换（替换成WAN口IP）,这样逐级替换，最终数据包中的IP地址成为一个公网IP,这种技术成为NAT(Network Address Translation,网络地址转换)

3）**IPv6**:IPv6并不是IPv4的升级版。这是互不相干的两个协议，彼此之间并不兼容；IPv6用16字节128位表示一个IP地址，但是目前IPv6还没有普及；

### 私有IP地址和公网IP地址

如果一个组织内部组建局域网，IP地址只用于局域网内的通信，而不直接连到Internet上，理论上使用任意的IP地址都可以，但是在RFC1918中进行规定，用于组建私网的网段也不能随意使用

只有一下几个网段能够用于组建私网：

(1)10. *. *. *：前8位是网络号		

(2)172.16.* .*~172.31. * .*：前12位是网络号

(3)192.168. *. *：前16位是网络号

包括在这个范围中的，都成为私有IP，其余的则成为全局IP(公网IP)